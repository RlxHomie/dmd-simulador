case ESTADOS.APROBADO: progreso = 60; break;
              case ESTADOS.EN_PAGO: progreso = 80; break;
              case ESTADOS.COMPLETADO: progreso = 100; break;
              case ESTADOS.CANCELADO: progreso = 0; break;
            }
            
            return `
              <tr>
                <td>
                  <div class="cliente-info">
                    <div class="cliente-avatar">${iniciales}</div>
                    <div>
                      <div class="cliente-nombre">${nombreCliente}</div>
                      <div class="cliente-ref">${plan.referencia || ''}</div>
                    </div>
                  </div>
                </td>
                <td>
                  <span class="estado-badge ${estado}">${this.obtenerTextoEstado(estado)}</span>
                </td>
                <td>${fecha.toLocaleDateString('es-ES')}</td>
                <td style="text-align: right;">${this.formatearMoneda(plan.totalImporte || 0)}</td>
                <td style="text-align: right;">${this.formatearMoneda(plan.cuotaMensual || 0)}</td>
                <td>
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div style="flex: 1; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
                      <div style="width: ${progreso}%; height: 100%; background: var(--primary); transition: width 0.3s;"></div>
                    </div>
                    <span style="font-size: 0.75rem; color: var(--text-secondary);">${progreso}%</span>
                  </div>
                </td>
                <td>
                  <button class="btn btn-icon" onclick="window.app && app.verDetallesPlan('${plan.referencia}')" title="Ver detalles">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                  </button>
                  <button class="btn btn-icon" onclick="window.app && app.actualizarEstadoPlan('${plan.referencia}')" title="Actualizar estado">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                  </button>
                </td>
              </tr>
            `;
          }).join('');
        } catch (error) {
          console.error('Error actualizando tabla de seguimiento:', error);
        }
      }

      obtenerTextoEstado(estado) {
        const textos = {
          simulado: 'Simulado',
          contratado: 'Contratado',
          en_negociacion: 'En Negociación',
          aprobado: 'Aprobado',
          en_pago: 'En Pago',
          completado: 'Completado',
          cancelado: 'Cancelado'
        };
        return textos[estado] || estado;
      }

      verDetallesPlan(referencia) {
        try {
          const plan = this.planes.find(p => p && p.referencia === referencia);
          if (!plan) return;
          
          safeSetText('detalleReferencia', referencia);
          
          // Generar timeline de eventos
          const eventos = this.generarTimelinePlan(plan);
          
          const html = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
              <div>
                <h4>Información del Cliente</h4>
                <p><strong>Nombre:</strong> ${plan.cliente?.nombre || 'No disponible'}</p>
                <p><strong>DNI:</strong> ${plan.cliente?.dni || 'No disponible'}</p>
                <p><strong>Email:</strong> ${plan.cliente?.email || 'No disponible'}</p>
                <p><strong>Estado actual:</strong> <span class="estado-badge ${plan.estado || ESTADOS.SIMULADO}">${this.obtenerTextoEstado(plan.estado || ESTADOS.SIMULADO)}</span></p>
              </div>
              <div>
                <h4>Resumen Financiero</h4>
                <p><strong>Deuda total:</strong> ${this.formatearMoneda(plan.totalImporte || 0)}</p>
                <p><strong>Total a pagar:</strong> ${this.formatearMoneda(plan.totalConDescuento || 0)}</p>
                <p><strong>Ahorro:</strong> ${this.formatearMoneda(plan.ahorro || 0)}</p>
                <p><strong>Cuota mensual:</strong> ${this.formatearMoneda(plan.cuotaMensual || 0)}</p>
                <p><strong>Número de cuotas:</strong> ${plan.numCuotas || 0}</p>
              </div>
            </div>
            
            <div class="timeline-container">
              <h4>Timeline del Plan</h4>
              <div class="timeline">
                ${eventos.map(evento => this.renderizarEventoTimeline(evento)).join('')}
              </div>
            </div>
            
            <div style="margin-top: 2rem;">
              <h4>Deudas Incluidas</h4>
              <table style="width: 100%; font-size: 0.875rem;">
                <thead>
                  <tr>
                    <th>Contrato</th>
                    <th>Producto</th>
                    <th>Entidad</th>
                    <th>Importe</th>
                    <th>Descuento</th>
                    <th>Final</th>
                  </tr>
                </thead>
                <tbody>
                  ${(plan.deudas || []).map(deuda => {
                    if (!deuda) return '';
                    return `
                      <tr>
                        <td>${deuda.contrato || ''}</td>
                        <td>${deuda.producto || ''}</td>
                        <td>${deuda.entidad || ''}</td>
                        <td style="text-align: right;">${this.formatearMoneda(deuda.importe || 0)}</td>
                        <td style="text-align: center;">${deuda.descuento || 0}%</td>
                        <td style="text-align: right; font-weight: 600; color: var(--success);">
                          ${this.formatearMoneda(deuda.importeConDescuento || 0)}
                        </td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
            
            <div style="margin-top: 2rem; text-align: right;">
              <button class="btn btn-secundario" onclick="window.app && app.cerrarModalDetalles()">Cerrar</button>
              <button class="btn btn-primario" onclick="window.app && app.descargarPDFPlan('${referencia}')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="7 10 12 15 17 10"></polyline>
                  <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Descargar PDF
              </button>
            </div>
          `;
          
          safeSetHTML('detallesPlanContent', html);
          const modal = safeGetElement('modalDetallesPlan');
          if (modal) modal.style.display = 'flex';
        } catch (error) {
          console.error('Error mostrando detalles del plan:', error);
        }
      }

      generarTimelinePlan(plan) {
        const eventos = [];
        
        if (!plan) return eventos;
        
        // Evento de creación
        eventos.push({
          fecha: plan.fecha,
          tipo: 'creacion',
          titulo: 'Plan creado',
          descripcion: 'Se creó el plan de reestructuración',
          estado: 'success'
        });
        
        // Eventos según el estado
        if (plan.estado === ESTADOS.CONTRATADO || 
            plan.estado === ESTADOS.EN_NEGOCIACION || 
            plan.estado === ESTADOS.APROBADO || 
            plan.estado === ESTADOS.EN_PAGO || 
            plan.estado === ESTADOS.COMPLETADO) {
          eventos.push({
            fecha: plan.fechaContratacion || plan.fecha,
            tipo: 'contratacion',
            titulo: 'Plan contratado',
            descripcion: 'El cliente aceptó y contrató el plan',
            estado: 'success'
          });
        }
        
        if (plan.estado === ESTADOS.EN_NEGOCIACION || 
            plan.estado === ESTADOS.APROBADO || 
            plan.estado === ESTADOS.EN_PAGO || 
            plan.estado === ESTADOS.COMPLETADO) {
          eventos.push({
            fecha: plan.fechaNegociacion || plan.fecha,
            tipo: 'negociacion',
            titulo: 'En negociación',
            descripcion: 'Iniciada negociación con entidades acreedoras',
            estado: 'warning'
          });
        }
        
        if (plan.estado === ESTADOS.APROBADO || 
            plan.estado === ESTADOS.EN_PAGO || 
            plan.estado === ESTADOS.COMPLETADO) {
          eventos.push({
            fecha: plan.fechaAprobacion || plan.fecha,
            tipo: 'aprobacion',
            titulo: 'Plan aprobado',
            descripcion: 'Todas las entidades aprobaron el plan',
            estado: 'success'
          });
        }
        
        if (plan.estado === ESTADOS.EN_PAGO || plan.estado === ESTADOS.COMPLETADO) {
          eventos.push({
            fecha: plan.fechaPrimerPago || plan.fecha,
            tipo: 'pago',
            titulo: 'Primer pago',
            descripcion: 'Se realizó el primer pago del plan',
            estado: 'success'
          });
        }
        
        if (plan.estado === ESTADOS.COMPLETADO) {
          eventos.push({
            fecha: plan.fechaCompletado || plan.fecha,
            tipo: 'completado',
            titulo: 'Plan completado',
            descripcion: 'Se completaron todos los pagos exitosamente',
            estado: 'success'
          });
        }
        
        if (plan.estado === ESTADOS.CANCELADO) {
          eventos.push({
            fecha: plan.fechaCancelacion || plan.fecha,
            tipo: 'cancelacion',
            titulo: 'Plan cancelado',
            descripcion: plan.motivoCancelacion || 'El plan fue cancelado',
            estado: 'danger'
          });
        }
        
        // Ordenar por fecha
        return eventos.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
      }

      renderizarEventoTimeline(evento) {
        if (!evento) return '';
        
        const fecha = evento.fecha ? new Date(evento.fecha) : new Date();
        const iconos = {
          creacion: '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline>',
          contratacion: '<polyline points="20 6 9 17 4 12"></polyline>',
          negociacion: '<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>',
          aprobacion: '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline>',
          pago: '<line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>',
          completado: '<circle cx="12" cy="12" r="10"></circle><polyline points="16 12 12 8 8 12"></polyline><line x1="12" y1="16" x2="12" y2="8"></line>',
          cancelacion: '<circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line>'
        };
        
        return `
          <div class="timeline-item">
            <div class="timeline-marker ${evento.estado}">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                ${iconos[evento.tipo] || '<circle cx="12" cy="12" r="10"></circle>'}
              </svg>
            </div>
            <div class="timeline-content">
              <div class="timeline-date">${fecha.toLocaleDateString('es-ES', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
              })}</div>
              <div class="timeline-title">${evento.titulo}</div>
              <div class="timeline-description">${evento.descripcion}</div>
            </div>
          </div>
        `;
      }

      cerrarModalDetalles() {
        const modal = safeGetElement('modalDetallesPlan');
        if (modal) modal.style.display = 'none';
      }

      async actualizarEstadoPlan(referencia) {
        try {
          const plan = this.planes.find(p => p && p.referencia === referencia);
          if (!plan) return;
          
          const estadoActual = plan.estado || ESTADOS.SIMULADO;
          
          // Crear un modal simple para actualizar el estado
          const modalHtml = `
            <div class="modal" id="modalActualizarEstado" style="display: flex;">
              <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                  <h3>Actualizar Estado - ${referencia}</h3>
                  <button type="button" class="btn btn-icon" onclick="document.getElementById('modalActualizarEstado').remove()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                  </button>
                </div>
                <div class="modal-body">
                  <div class="campo mb-2">
                    <label>Estado actual</label>
                    <span class="estado-badge ${estadoActual}">${this.obtenerTextoEstado(estadoActual)}</span>
                  </div>
                  
                  <div class="campo mb-2">
                    <label for="nuevoEstado">Nuevo estado</label>
                    <select id="nuevoEstado" class="form-control">
                      ${Object.entries(ESTADOS).map(([key, value]) => 
                        `<option value="${value}" ${value === estadoActual ? 'disabled' : ''}>
                          ${this.obtenerTextoEstado(value)}
                        </option>`
                      ).join('')}
                    </select>
                  </div>
                  
                  <div class="campo mb-2">
                    <label for="notasEstado">Notas (opcional)</label>
                    <textarea id="notasEstado" rows="3" placeholder="Añade cualquier información relevante..."></textarea>
                  </div>
                  
                  <div style="text-align: right; margin-top: 1.5rem;">
                    <button class="btn btn-secundario" onclick="document.getElementById('modalActualizarEstado').remove()">
                      Cancelar
                    </button>
                    <button class="btn btn-primario" onclick="window.app && app.guardarNuevoEstado('${referencia}')">
                      Actualizar Estado
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `;
          
          document.body.insertAdjacentHTML('beforeend', modalHtml);
        } catch (error) {
          console.error('Error actualizando estado del plan:', error);
        }
      }

      async guardarNuevoEstado(referencia) {
        try {
          const nuevoEstadoEl = safeGetElement('nuevoEstado');
          const notasEstadoEl = safeGetElement('notasEstado');
          
          if (!nuevoEstadoEl) return;
          
          const nuevoEstado = nuevoEstadoEl.value;
          const notas = notasEstadoEl ? notasEstadoEl.value : '';
          
          // Buscar el plan
          const planIndex = this.planes.findIndex(p => p && p.referencia === referencia);
          if (planIndex === -1) return;
          
          // Actualizar el estado
          this.planes[planIndex].estado = nuevoEstado;
          this.planes[planIndex].ultimaActualizacion = new Date().toISOString();
          
          // Añadir evento al historial
          if (!this.planes[planIndex].historial) {
            this.planes[planIndex].historial = [];
          }
          
          this.planes[planIndex].historial.push({
            fecha: new Date().toISOString(),
            tipo: 'cambio_estado',
            estado: nuevoEstado,
            notas: notas,
            usuario: 'Usuario Actual' // En producción, usar el usuario autenticado
          });
          
          // Guardar fechas específicas según el estado
          switch(nuevoEstado) {
            case ESTADOS.CONTRATADO:
              this.planes[planIndex].fechaContratacion = new Date().toISOString();
              break;
            case ESTADOS.EN_NEGOCIACION:
              this.planes[planIndex].fechaNegociacion = new Date().toISOString();
              break;
            case ESTADOS.APROBADO:
              this.planes[planIndex].fechaAprobacion = new Date().toISOString();
              break;
            case ESTADOS.EN_PAGO:
              this.planes[planIndex].fechaPrimerPago = new Date().toISOString();
              break;
            case ESTADOS.COMPLETADO:
              this.planes[planIndex].fechaCompletado = new Date().toISOString();
              break;
            case ESTADOS.CANCELADO:
              this.planes[planIndex].fechaCancelacion = new Date().toISOString();
              this.planes[planIndex].motivoCancelacion = notas;
              break;
          }
          
          // Guardar en GitHub si estamos online
          if (this.online) {
            try {
              await this.guardarPlanEnGitHub(this.planes[planIndex]);
              this.mostrarNotificacion('Estado actualizado correctamente', 'success');
            } catch (error) {
              console.error('Error actualizando estado:', error);
              this.mostrarNotificacion('Error al actualizar el estado', 'error');
            }
          } else {
            // Guardar localmente
            this.guardarPlanLocal(this.planes[planIndex]);
            this.mostrarNotificacion('Estado actualizado localmente', 'warning');
          }
          
          // Cerrar modal y actualizar vistas
          const modalActualizar = safeGetElement('modalActualizarEstado');
          if (modalActualizar) modalActualizar.remove();
          
          this.actualizarTablaSeguimiento();
          this.actualizarDashboard();
        } catch (error) {
          console.error('Error guardando nuevo estado:', error);
        }
      }

      descargarPDFPlan(referencia) {
        const plan = this.planes.find(p => p && p.referencia === referencia);
        if (!plan) return;
        
        this.planActual = plan;
        this.descargarPDF();
      }

      // ==================== GESTIÓN DE DEUDAS ====================
      agregarFilaDeuda(datos = {}) {
        try {
          const tbody = safeGetElement('tablaDeudas');
          if (!tbody) return;
          
          const fila = document.createElement('tr');
          
          fila.innerHTML = `
            <td>
              <input type="text" class="contrato" value="${datos.contrato || ''}" 
                     placeholder="Ej: 1234567890" required>
            </td>
            <td>
              <select class="producto" required>
                ${CONFIG.TIPOS_PRODUCTO.map(p => 
                  `<option value="${p.tipo}">${p.tipo}</option>`
                ).join('')}
              </select>
            </td>
            <td>
              <select class="entidad" required>
                ${CONFIG.ENTIDADES.map(e => 
                  `<option value="${e}">${e}</option>`
                ).join('')}
              </select>
            </td>
            <td>
              <input type="number" class="importe" min="0" step="0.01" 
                     value="${datos.importe || ''}" placeholder="0,00" required>
            </td>
            <td>
              <input type="number" class="descuento" min="0" max="100" 
                     value="${datos.descuento || ''}" placeholder="0" required>
            </td>
            <td class="importe-descuento text-right">0,00 €</td>
            <td>
              <button type="button" class="btn btn-icon btn-danger" title="Eliminar">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
              </button>
            </td>
          `;

          // Establecer valores si se proporcionaron
          if (datos.producto) {
            const productoSelect = fila.querySelector('.producto');
            if (productoSelect) productoSelect.value = datos.producto;
          }
          if (datos.entidad) {
            const entidadSelect = fila.querySelector('.entidad');
            if (entidadSelect) entidadSelect.value = datos.entidad;
          }

          // Event listeners
          const inputs = fila.querySelectorAll('input, select');
          inputs.forEach(input => {
            input.addEventListener('input', () => this.actualizarFila(fila));
            input.addEventListener('change', () => this.actualizarFila(fila));
          });

          const btnEliminar = fila.querySelector('.btn-danger');
          if (btnEliminar) {
            btnEliminar.addEventListener('click', () => {
              if (tbody.children.length > 1) {
                fila.remove();
                this.actualizarTotales();
              } else {
                this.mostrarNotificacion('Debe mantener al menos una deuda', 'warning');
              }
            });
          }

          tbody.appendChild(fila);
          this.actualizarFila(fila);
        } catch (error) {
          console.error('Error agregando fila de deuda:', error);
        }
      }

      actualizarFila(fila) {
        try {
          if (!fila) return;
          
          const productoEl = fila.querySelector('.producto');
          const importeEl = fila.querySelector('.importe');
          const descuentoEl = fila.querySelector('.descuento');
          const importeDescuentoEl = fila.querySelector('.importe-descuento');
          
          if (!productoEl || !importeEl || !descuentoEl || !importeDescuentoEl) return;
          
          const producto = productoEl.value;
          const importe = parseFloat(importeEl.value) || 0;
          let descuento = parseFloat(descuentoEl.value) || 0;
          
          // Validar descuento máximo
          const tipoProducto = CONFIG.TIPOS_PRODUCTO.find(tp => tp.tipo === producto);
          const maxDescuento = tipoProducto ? tipoProducto.maxDescuento : 100;
          
          if (descuento > maxDescuento) {
            descuento = maxDescuento;
            descuentoEl.value = maxDescuento;
            this.mostrarNotificacion(
              `Descuento máximo para ${producto}: ${maxDescuento}%`, 
              'warning'
            );
          }
          
          const importeConDescuento = importe * (1 - descuento / 100);
          importeDescuentoEl.textContent = this.formatearMoneda(importeConDescuento);
          
          this.actualizarTotales();
        } catch (error) {
          console.error('Error actualizando fila:', error);
        }
      }

      actualizarTotales() {
        try {
          const filas = safeQuerySelectorAll('#tablaDeudas tr');
          let totalImporte = 0;
          let totalImporteFinal = 0;
          
          filas.forEach(fila => {
            const importeEl = fila.querySelector('.importe');
            const descuentoEl = fila.querySelector('.descuento');
            
            if (importeEl && descuentoEl) {
              const importe = parseFloat(importeEl.value) || 0;
              const descuento = parseFloat(descuentoEl.value) || 0;
              const importeFinal = importe * (1 - descuento / 100);
              
              totalImporte += importe;
              totalImporteFinal += importeFinal;
            }
          });
          
          const descuentoMedio = totalImporte > 0 
            ? ((totalImporte - totalImporteFinal) / totalImporte) * 100 
            : 0;
          
          safeSetText('totalImporte', this.formatearMoneda(totalImporte));
          safeSetText('totalImporteFinal', this.formatearMoneda(totalImporteFinal));
          safeSetText('totalDescuentoMedio', `${descuentoMedio.toFixed(1)}%`);
          safeSetText('totalDeudasCount', 
            `${filas.length} deuda${filas.length !== 1 ? 's' : ''}`);
        } catch (error) {
          console.error('Error actualizando totales:', error);
        }
      }

      // ==================== SIMULACIÓN ====================
      simularPlan() {
        try {
          // Validar datos
          const datosCliente = this.obtenerDatosCliente();
          if (!datosCliente) return;

          const deudas = this.obtenerDeudas();
          if (!deudas) return;

          const numCuotasEl = safeGetElement('numCuotas');
          if (!numCuotasEl) return;
          
          const numCuotas = parseInt(numCuotasEl.value);

          // Calcular totales
          const totalImporte = deudas.reduce((sum, d) => sum + d.importe, 0);
          const totalConDescuento = deudas.reduce((sum, d) => sum + d.importeConDescuento, 0);
          const ahorro = totalImporte - totalConDescuento;
          const descuentoMedio = (ahorro / totalImporte) * 100;
          const cuotaMensual = totalConDescuento / numCuotas;

          // Validar descuento total
          if (descuentoMedio > CONFIG.MAX_DESCUENTO_TOTAL) {
            this.mostrarNotificacion(
              `El descuento total no puede superar el ${CONFIG.MAX_DESCUENTO_TOTAL}%`, 
              'error'
            );
            return;
          }

          // Calcular comisiones
          const comisionBase = Math.max(
            ahorro * (this.comisiones.porcentaje / 100),
            this.comisiones.minimo
          );
          const iva = comisionBase * (this.comisiones.iva / 100);
          const comisionTotal = comisionBase + iva;

          // Guardar simulación
          this.simulacionActual = {
            referencia: this.generarReferencia(),
            fecha: new Date().toISOString(),
            estado: ESTADOS.SIMULADO,
            cliente: datosCliente,
            numCuotas,
            deudas,
            totalImporte,
            totalConDescuento,
            ahorro,
            descuentoMedio,
            cuotaMensual,
            comisiones: {
              base: comisionBase,
              iva: iva,
              total: comisionTotal,
              porcentaje: this.comisiones.porcentaje
            }
          };

          // Mostrar simulación
          this.mostrarSimulacion();

        } catch (error) {
          console.error('Error en simulación:', error);
          this.mostrarNotificacion('Error al simular el plan',           <table class="seguimiento-table">
            <thead>
              <tr>
                <th>Cliente</th>
                <th>Estado</th>
                <th>Fecha Creación</th>
                <th>Deuda Total</th>
                <th>Cuota</th>
                <th>Progreso</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tablaSeguimiento">
              <!-- Se llenará dinámicamente -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para cargar planes -->
  <div id="modalPlanes" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Planes Guardados</h3>
        <button type="button" class="btn btn-icon" onclick="window.app && app.cerrarModalPlanes()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <input type="text" id="buscarPlan" placeholder="Buscar por nombre, DNI o referencia..." class="search-box">
        <div id="listaPlanes" class="planes-grid">
          <!-- Se llenará dinámicamente -->
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de detalles del plan -->
  <div id="modalDetallesPlan" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 900px;">
      <div class="modal-header">
        <h3>Detalles del Plan - <span id="detalleReferencia"></span></h3>
        <button type="button" class="btn btn-icon" onclick="window.app && app.cerrarModalDetalles()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div id="detallesPlanContent">
          <!-- Se llenará dinámicamente -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==================== CONFIGURACIÓN GLOBAL ====================
    const CONFIG = {
      // URLs del sistema
      API_URL: window.location.hostname === 'localhost' 
        ? 'http://localhost:8888/.netlify/functions' 
        : '/.netlify/functions',
      GITHUB_REPO: 'tu-usuario/dmd-simulador', // Cambiar por tu repo
      
      // Valores por defecto (se actualizarán desde los archivos JSON)
      ENTIDADES: [],
      TIPOS_PRODUCTO: [],
      MAX_DESCUENTO_TOTAL: 95,
      
      // Formato de moneda
      FORMATO_MONEDA: {
        style: "currency",
        currency: "EUR",
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }
    };

    // Estados del plan
    const ESTADOS = {
      SIMULADO: 'simulado',
      CONTRATADO: 'contratado',
      EN_NEGOCIACION: 'en_negociacion',
      APROBADO: 'aprobado',
      EN_PAGO: 'en_pago',
      COMPLETADO: 'completado',
      CANCELADO: 'cancelado'
    };

    // ==================== UTILIDADES DE PROTECCIÓN ====================
    function safeGetElement(id) {
      try {
        return document.getElementById(id);
      } catch (e) {
        console.warn(`Elemento con id '${id}' no encontrado`);
        return null;
      }
    }

    function safeSetText(id, text) {
      const element = safeGetElement(id);
      if (element) {
        element.textContent = text;
      }
    }

    function safeSetHTML(id, html) {
      const element = safeGetElement(id);
      if (element) {
        element.innerHTML = html;
      }
    }

    function safeAddEventListener(id, event, handler) {
      const element = safeGetElement(id);
      if (element) {
        element.addEventListener(event, handler);
      }
    }

    function safeQuerySelector(selector) {
      try {
        return document.querySelector(selector);
      } catch (e) {
        console.warn(`Selector '${selector}' no encontrado`);
        return null;
      }
    }

    function safeQuerySelectorAll(selector) {
      try {
        return document.querySelectorAll(selector);
      } catch (e) {
        console.warn(`Selector '${selector}' no encontrado`);
        return [];
      }
    }

    // ==================== APLICACIÓN PRINCIPAL ====================
    class DMDApp {
      constructor() {
        this.planes = [];
        this.configuracion = {};
        this.comisiones = {
          porcentaje: 20, // 20% de comisión por defecto
          minimo: 500,    // Mínimo 500€
          iva: 21         // 21% IVA
        };
        this.online = navigator.onLine;
        this.simulacionActual = null;
        this.currentTab = 'dashboard';
        this.charts = {};
        this.analytics = {
          planesHoy: 0,
          planesSemana: 0,
          planesMes: 0,
          tasaConversion: 0,
          ahorroTotal: 0,
          comisionesTotal: 0,
          clientesActivos: 0
        };
        this.initialized = false;
      }

      async initApp() {
        if (this.initialized) return;
        
        try {
          // Cargar configuración
          await this.loadConfiguration();
          
          // Inicializar eventos
          this.initEventListeners();
          
          // Actualizar estado
          this.updateConnectionStatus();
          
          // Ocultar pantalla de carga
          const loadingScreen = safeGetElement('loadingScreen');
          if (loadingScreen) {
            loadingScreen.style.opacity = '0';
            setTimeout(() => {
              loadingScreen.style.display = 'none';
            }, 300);
          }
          
          // Cargar planes si estamos online
          if (this.online) {
            await this.loadPlanes().catch(e => console.error('Error cargando planes:', e));
          }
          
          // Inicializar dashboard
          this.initDashboard();
          
          // Inicializar tabla con primera fila
          this.agregarFilaDeuda();
          
          this.initialized = true;
          
        } catch (error) {
          console.error('Error iniciando aplicación:', error);
          this.mostrarNotificacion('Error al cargar la configuración', 'error');
        }
      }

      async loadConfiguration() {
        try {
          // Cargar archivos de configuración
          const [entidades, productos, configuracion] = await Promise.all([
            fetch('/config/entidades.json').then(r => r.json()).catch(() => ({ entidades: [] })),
            fetch('/config/productos.json').then(r => r.json()).catch(() => ({ productos: [] })),
            fetch('/config/configuracion.json').then(r => r.json()).catch(() => ({}))
          ]);

          // Actualizar CONFIG global
          CONFIG.ENTIDADES = (entidades.entidades || [])
            .filter(e => e && e.activo)
            .map(e => e.nombre);
          
          CONFIG.TIPOS_PRODUCTO = (productos.productos || [])
            .filter(p => p && p.activo);
          
          // Cargar configuración de comisiones si existe
          if (configuracion.comisiones) {
            this.comisiones = {
              ...this.comisiones,
              ...configuracion.comisiones
            };
          }
          
          this.configuracion = configuracion;
          
          // Si no hay configuración, usar valores por defecto
          if (CONFIG.ENTIDADES.length === 0) {
            CONFIG.ENTIDADES = [
              "BBVA", "CaixaBank", "Santander", "Sabadell", "Bankinter"
            ];
          }
          
          if (CONFIG.TIPOS_PRODUCTO.length === 0) {
            CONFIG.TIPOS_PRODUCTO = [
              { tipo: "Micropréstamo", maxDescuento: 50, color: "#ff9500" },
              { tipo: "Tarjeta de Crédito", maxDescuento: 25, color: "#af52de" },
              { tipo: "Préstamo Personal", maxDescuento: 20, color: "#0a84ff" }
            ];
          }
          
          console.log('Configuración cargada:', {
            entidades: CONFIG.ENTIDADES.length,
            productos: CONFIG.TIPOS_PRODUCTO.length
          });
          
        } catch (error) {
          console.warn('Usando configuración por defecto:', error);
          
          // Configuración por defecto si falla la carga
          CONFIG.ENTIDADES = [
            "BBVA", "CaixaBank", "Santander", "Sabadell", "Bankinter"
          ];
          
          CONFIG.TIPOS_PRODUCTO = [
            { tipo: "Micropréstamo", maxDescuento: 50, color: "#ff9500" },
            { tipo: "Tarjeta de Crédito", maxDescuento: 25, color: "#af52de" },
            { tipo: "Préstamo Personal", maxDescuento: 20, color: "#0a84ff" }
          ];
        }
      }

      initEventListeners() {
        // Formulario - prevenir submit por defecto
        safeAddEventListener('formularioSimulador', 'submit', (e) => {
          e.preventDefault();
          this.calcularYGuardarPlan();
        });

        // Botones
        safeAddEventListener('btnAgregarFila', 'click', () => this.agregarFilaDeuda());
        safeAddEventListener('btnCargarPlan', 'click', () => this.mostrarModalPlanes());
        safeAddEventListener('btnReAnalizar', 'click', () => this.reiniciarFormulario());
        safeAddEventListener('btnGuardarBorrador', 'click', () => this.guardarBorrador());
        safeAddEventListener('btnDescargarPDF', 'click', () => this.descargarPDF());
        safeAddEventListener('btnVerEnGitHub', 'click', () => this.verEnGitHub());
        
        // Nuevos botones de simulación
        safeAddEventListener('btnSimular', 'click', () => this.simularPlan());
        safeAddEventListener('btnConfirmarPlan', 'click', () => this.confirmarYGuardarPlan());
        safeAddEventListener('btnEnviarEmail', 'click', () => this.enviarPorEmail());

        // Búsqueda en modal
        safeAddEventListener('buscarPlan', 'input', (e) => this.filtrarPlanes(e.target.value));

        // Filtros de seguimiento
        safeAddEventListener('buscarSeguimiento', 'input', () => this.actualizarTablaSeguimiento());
        safeAddEventListener('filtroEstado', 'change', () => this.actualizarTablaSeguimiento());
        safeAddEventListener('filtroPeriodo', 'change', () => this.actualizarTablaSeguimiento());

        // Estado de conexión
        window.addEventListener('online', () => this.updateConnectionStatus(true));
        window.addEventListener('offline', () => this.updateConnectionStatus(false));

        // Cerrar modal al hacer clic fuera
        safeAddEventListener('modalPlanes', 'click', (e) => {
          if (e.target.id === 'modalPlanes') {
            this.cerrarModalPlanes();
          }
        });

        safeAddEventListener('modalDetallesPlan', 'click', (e) => {
          if (e.target.id === 'modalDetallesPlan') {
            this.cerrarModalDetalles();
          }
        });
      }

      // ==================== NAVEGACIÓN POR TABS ====================
      switchTab(tab, event) {
        if (event) {
          event.preventDefault();
        }
        
        // Actualizar tabs activos
        safeQuerySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        if (event && event.target) {
          event.target.classList.add('active');
        }
        
        // Ocultar todos los contenedores
        const dashboardContainer = safeGetElement('dashboardContainer');
        const simuladorContainer = safeGetElement('simuladorContainer');
        const seguimientoContainer = safeGetElement('seguimientoContainer');
        
        if (dashboardContainer) dashboardContainer.style.display = 'none';
        if (simuladorContainer) simuladorContainer.style.display = 'none';
        if (seguimientoContainer) seguimientoContainer.style.display = 'none';
        
        // Mostrar contenedor seleccionado
        switch(tab) {
          case 'dashboard':
            if (dashboardContainer) {
              dashboardContainer.style.display = 'block';
              dashboardContainer.classList.add('active');
            }
            this.actualizarDashboard();
            break;
          case 'simulador':
            if (simuladorContainer) simuladorContainer.style.display = 'block';
            break;
          case 'seguimiento':
            if (seguimientoContainer) seguimientoContainer.style.display = 'block';
            this.actualizarTablaSeguimiento();
            break;
        }
        
        this.currentTab = tab;
      }

      // ==================== DASHBOARD ====================
      initDashboard() {
        try {
          // Verificar que Chart.js esté disponible
          if (typeof Chart === 'undefined') {
            console.error('Chart.js no está cargado');
            return;
          }

          // Inicializar Chart.js
          const ctxEvolucion = safeGetElement('chartEvolucion');
          if (ctxEvolucion && ctxEvolucion.getContext) {
            this.charts.evolucion = new Chart(ctxEvolucion.getContext('2d'), {
              type: 'line',
              data: {
                labels: [],
                datasets: [{
                  label: 'Planes Creados',
                  data: [],
                  borderColor: 'rgb(0, 113, 227)',
                  backgroundColor: 'rgba(0, 113, 227, 0.1)',
                  tension: 0.4,
                  fill: true
                }, {
                  label: 'Planes Contratados',
                  data: [],
                  borderColor: 'rgb(52, 199, 89)',
                  backgroundColor: 'rgba(52, 199, 89, 0.1)',
                  tension: 0.4,
                  fill: true
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                  mode: 'index',
                  intersect: false
                },
                plugins: {
                  legend: {
                    position: 'bottom',
                    labels: {
                      padding: 15,
                      usePointStyle: true
                    }
                  },
                  tooltip: {
                    mode: 'index',
                    intersect: false
                  }
                },
                scales: {
                  x: {
                    grid: {
                      display: false
                    }
                  },
                  y: {
                    beginAtZero: true,
                    ticks: {
                      precision: 0
                    },
                    grid: {
                      borderDash: [3, 3]
                    }
                  }
                }
              }
            });
          }

          const ctxDistribucion = safeGetElement('chartDistribucion');
          if (ctxDistribucion && ctxDistribucion.getContext) {
            this.charts.distribucion = new Chart(ctxDistribucion.getContext('2d'), {
              type: 'doughnut',
              data: {
                labels: [],
                datasets: [{
                  data: [],
                  backgroundColor: [],
                  borderWidth: 2,
                  borderColor: '#fff'
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: 'right',
                    labels: {
                      padding: 10,
                      usePointStyle: true,
                      font: {
                        size: 12
                      }
                    }
                  },
                  tooltip: {
                    callbacks: {
                      label: function(context) {
                        let label = context.label || '';
                        if (label) {
                          label += ': ';
                        }
                        const value = context.parsed;
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                        label += value + ' (' + percentage + '%)';
                        return label;
                      }
                    }
                  }
                }
              }
            });
          }

          const ctxFunnel = safeGetElement('chartFunnel');
          if (ctxFunnel && ctxFunnel.getContext) {
            this.charts.funnel = new Chart(ctxFunnel.getContext('2d'), {
              type: 'bar',
              data: {
                labels: ['Simulados', 'Contratados', 'En Negociación', 'Aprobados', 'En Pago'],
                datasets: [{
                  data: [],
                  backgroundColor: [
                    'rgba(0, 113, 227, 0.8)',
                    'rgba(52, 199, 89, 0.8)',
                    'rgba(255, 204, 0, 0.8)',
                    'rgba(52, 199, 89, 0.6)',
                    'rgba(0, 113, 227, 0.6)'
                  ],
                  borderWidth: 0
                }]
              },
              options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: false
                  },
                  tooltip: {
                    callbacks: {
                      label: function(context) {
                        return context.parsed.x + ' planes';
                      }
                    }
                  }
                },
                scales: {
                  x: {
                    beginAtZero: true,
                    ticks: {
                      precision: 0
                    },
                    grid: {
                      borderDash: [3, 3]
                    }
                  },
                  y: {
                    grid: {
                      display: false
                    }
                  }
                }
              }
            });
          }

          this.actualizarDashboard();
        } catch (error) {
          console.error('Error inicializando dashboard:', error);
        }
      }

      actualizarDashboard() {
        try {
          // Calcular KPIs
          this.calcularKPIs();
          
          // Actualizar valores en la UI
          safeSetText('kpiPlanesCreados', this.analytics.planesMes);
          safeSetText('kpiConversion', `${this.analytics.tasaConversion.toFixed(1)}%`);
          safeSetText('kpiAhorro', this.formatearMoneda(this.analytics.ahorroTotal));
          safeSetText('kpiComisiones', this.formatearMoneda(this.analytics.comisionesTotal));
          
          // Actualizar gráficos
          this.actualizarGraficos();
        } catch (error) {
          console.error('Error actualizando dashboard:', error);
        }
      }

      calcularKPIs() {
        try {
          const ahora = new Date();
          const hoy = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate());
          const hace7Dias = new Date(hoy.getTime() - 7 * 24 * 60 * 60 * 1000);
          const hace30Dias = new Date(hoy.getTime() - 30 * 24 * 60 * 60 * 1000);
          
          let planesHoy = 0;
          let planesSemana = 0;
          let planesMes = 0;
          let planesSimulados = 0;
          let planesContratados = 0;
          let ahorroTotal = 0;
          let comisionesTotal = 0;
          
          this.planes.forEach(plan => {
            if (!plan || !plan.fecha) return;
            
            const fechaPlan = new Date(plan.fecha);
            
            if (fechaPlan >= hoy) planesHoy++;
            if (fechaPlan >= hace7Dias) planesSemana++;
            if (fechaPlan >= hace30Dias) planesMes++;
            
            // Contar por estado
            const estado = plan.estado || ESTADOS.SIMULADO;
            if (estado === ESTADOS.SIMULADO) planesSimulados++;
            if (estado === ESTADOS.CONTRATADO || estado === ESTADOS.EN_PAGO || estado === ESTADOS.COMPLETADO) {
              planesContratados++;
              ahorroTotal += plan.ahorro || 0;
              if (plan.comisiones) {
                comisionesTotal += plan.comisiones.total || 0;
              }
            }
          });
          
          this.analytics = {
            planesHoy,
            planesSemana,
            planesMes,
            tasaConversion: planesSimulados > 0 ? (planesContratados / planesSimulados) * 100 : 0,
            ahorroTotal,
            comisionesTotal,
            clientesActivos: new Set(this.planes.map(p => p.cliente?.dni).filter(Boolean)).size
          };
        } catch (error) {
          console.error('Error calculando KPIs:', error);
        }
      }

      actualizarGraficos() {
        try {
          // Evolución mensual
          const meses = this.obtenerUltimosMeses(6);
          const datosEvolucion = this.calcularEvolucionMensual(meses);
          
          if (this.charts.evolucion) {
            this.charts.evolucion.data.labels = meses.map(m => m.label);
            this.charts.evolucion.data.datasets[0].data = datosEvolucion.creados;
            this.charts.evolucion.data.datasets[1].data = datosEvolucion.contratados;
            this.charts.evolucion.update();
          }
          
          // Distribución por tipo
          const distribucion = this.calcularDistribucionTipos();
          if (this.charts.distribucion) {
            this.charts.distribucion.data.labels = Object.keys(distribucion);
            this.charts.distribucion.data.datasets[0].data = Object.values(distribucion);
            this.charts.distribucion.data.datasets[0].backgroundColor = CONFIG.TIPOS_PRODUCTO.map(t => t.color || '#cccccc');
            this.charts.distribucion.update();
          }
          
          // Funnel de conversión
          const funnel = this.calcularFunnel();
          if (this.charts.funnel) {
            this.charts.funnel.data.datasets[0].data = [
              funnel.simulados,
              funnel.contratados,
              funnel.en_negociacion,
              funnel.aprobados,
              funnel.en_pago
            ];
            this.charts.funnel.update();
          }
        } catch (error) {
          console.error('Error actualizando gráficos:', error);
        }
      }

      obtenerUltimosMeses(cantidad) {
        const meses = [];
        const ahora = new Date();
        
        for (let i = cantidad - 1; i >= 0; i--) {
          const fecha = new Date(ahora.getFullYear(), ahora.getMonth() - i, 1);
          meses.push({
            fecha,
            label: fecha.toLocaleDateString('es-ES', { month: 'short', year: 'numeric' })
          });
        }
        
        return meses;
      }

      calcularEvolucionMensual(meses) {
        const creados = new Array(meses.length).fill(0);
        const contratados = new Array(meses.length).fill(0);
        
        this.planes.forEach(plan => {
          if (!plan || !plan.fecha) return;
          
          const fechaPlan = new Date(plan.fecha);
          
          meses.forEach((mes, index) => {
            const mesInicio = mes.fecha;
            const mesFin = new Date(mesInicio.getFullYear(), mesInicio.getMonth() + 1, 0);
            
            if (fechaPlan >= mesInicio && fechaPlan <= mesFin) {
              creados[index]++;
              
              const estado = plan.estado || ESTADOS.SIMULADO;
              if (estado === ESTADOS.CONTRATADO || estado === ESTADOS.EN_PAGO || estado === ESTADOS.COMPLETADO) {
                contratados[index]++;
              }
            }
          });
        });
        
        return { creados, contratados };
      }

      calcularDistribucionTipos() {
        const distribucion = {};
        
        CONFIG.TIPOS_PRODUCTO.forEach(tipo => {
          distribucion[tipo.tipo] = 0;
        });
        
        this.planes.forEach(plan => {
          if (plan && plan.deudas && Array.isArray(plan.deudas)) {
            plan.deudas.forEach(deuda => {
              if (deuda && deuda.producto && distribucion[deuda.producto] !== undefined) {
                distribucion[deuda.producto]++;
              }
            });
          }
        });
        
        return distribucion;
      }

      calcularFunnel() {
        const funnel = {
          simulados: 0,
          contratados: 0,
          en_negociacion: 0,
          aprobados: 0,
          en_pago: 0
        };
        
        this.planes.forEach(plan => {
          if (!plan) return;
          
          const estado = plan.estado || ESTADOS.SIMULADO;
          
          switch(estado) {
            case ESTADOS.SIMULADO:
              funnel.simulados++;
              break;
            case ESTADOS.CONTRATADO:
              funnel.contratados++;
              break;
            case ESTADOS.EN_NEGOCIACION:
              funnel.en_negociacion++;
              break;
            case ESTADOS.APROBADO:
              funnel.aprobados++;
              break;
            case ESTADOS.EN_PAGO:
              funnel.en_pago++;
              break;
          }
        });
        
        return funnel;
      }

      updateChart(tipo, periodo, event) {
        try {
          if (!event || !event.target) return;
          
          // Actualizar botones de filtro
          const parent = event.target.parentElement;
          if (parent) {
            parent.querySelectorAll('.chart-filter').forEach(btn => {
              btn.classList.remove('active');
            });
          }
          event.target.classList.add('active');
          
          // Actualizar datos según el período seleccionado
          let meses;
          switch(periodo) {
            case '6m':
              meses = this.obtenerUltimosMeses(6);
              break;
            case '12m':
              meses = this.obtenerUltimosMeses(12);
              break;
            case 'ytd':
              const ahora = new Date();
              meses = this.obtenerUltimosMeses(ahora.getMonth() + 1);
              break;
            default:
              meses = this.obtenerUltimosMeses(6);
          }
          
          const datosEvolucion = this.calcularEvolucionMensual(meses);
          if (this.charts.evolucion) {
            this.charts.evolucion.data.labels = meses.map(m => m.label);
            this.charts.evolucion.data.datasets[0].data = datosEvolucion.creados;
            this.charts.evolucion.data.datasets[1].data = datosEvolucion.contratados;
            this.charts.evolucion.update();
          }
        } catch (error) {
          console.error('Error actualizando chart:', error);
        }
      }

      // ==================== SEGUIMIENTO ====================
      actualizarTablaSeguimiento() {
        try {
          const busquedaEl = safeGetElement('buscarSeguimiento');
          const estadoFiltroEl = safeGetElement('filtroEstado');
          const periodoFiltroEl = safeGetElement('filtroPeriodo');
          
          const busqueda = busquedaEl ? busquedaEl.value.toLowerCase() : '';
          const estadoFiltro = estadoFiltroEl ? estadoFiltroEl.value : '';
          const periodoFiltro = periodoFiltroEl ? parseInt(periodoFiltroEl.value) : 30;
          
          // Filtrar planes
          let planesFiltrados = this.planes.filter(plan => {
            if (!plan) return false;
            
            // Filtro de búsqueda
            if (busqueda) {
              const nombreCliente = (plan.cliente?.nombre || plan.cliente || '').toString();
              const dni = (plan.cliente?.dni || plan.dni || '').toString();
              const ref = (plan.referencia || '').toString();
              
              if (!nombreCliente.toLowerCase().includes(busqueda) &&
                  !dni.toLowerCase().includes(busqueda) &&
                  !ref.toLowerCase().includes(busqueda)) {
                return false;
              }
            }
            
            // Filtro de estado
            if (estadoFiltro && (plan.estado || ESTADOS.SIMULADO) !== estadoFiltro) {
              return false;
            }
            
            // Filtro de período
            if (periodoFiltro > 0 && plan.fecha) {
              const fechaPlan = new Date(plan.fecha);
              const ahora = new Date();
              const diferenciaDias = (ahora - fechaPlan) / (1000 * 60 * 60 * 24);
              if (diferenciaDias > periodoFiltro) {
                return false;
              }
            }
            
            return true;
          });
          
          // Actualizar contador
          safeSetText('totalPlanesSeguimiento', 
            `${planesFiltrados.length} plan${planesFiltrados.length !== 1 ? 'es' : ''}`);
          
          // Renderizar tabla
          const tbody = safeGetElement('tablaSeguimiento');
          if (!tbody) return;
          
          if (planesFiltrados.length === 0) {
            tbody.innerHTML = `
              <tr>
                <td colspan="7" style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                  No se encontraron planes con los criterios seleccionados
                </td>
              </tr>
            `;
            return;
          }
          
          tbody.innerHTML = planesFiltrados.map(plan => {
            if (!plan) return '';
            
            const estado = plan.estado || ESTADOS.SIMULADO;
            const fecha = plan.fecha ? new Date(plan.fecha) : new Date();
            const nombreCliente = (plan.cliente?.nombre || plan.cliente || 'Sin nombre').toString();
            const iniciales = nombreCliente.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            
            // Calcular progreso (ejemplo simple)
            let progreso = 0;
            switch(estado) {
              case ESTADOS.SIMULADO: progreso = 10; break;
              case ESTADOS.CONTRATADO: progreso = 25; break;
              case ESTADOS.EN_NEGOCIACION: progreso = 40; break;<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simulador de Reestructuración de Deuda - DMD Asesores</title>
  <meta name="description" content="Calcula y optimiza planes de reestructuración de deuda con DMD Asesores">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --primary: #0071e3;
      --primary-hover: #0051a3;
      --success: #34c759;
      --danger: #ff3b30;
      --warning: #ffcc00;
      --background: #f5f5f7;
      --surface: #ffffff;
      --text-primary: #1d1d1f;
      --text-secondary: #666;
      --border: #e5e5ea;
      --shadow: 0 4px 12px rgba(0,0,0,0.1);
      --shadow-hover: 0 8px 24px rgba(0,0,0,0.15);
      --radius: 12px;
      --radius-lg: 18px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { box-sizing: border-box; }
    
    html, body { 
      margin: 0; 
      padding: 0; 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; 
      background: var(--background); 
      color: var(--text-primary);
      line-height: 1.6;
    }
    
    body { padding: 20px; }

    /* Navigation Tabs */
    .nav-tabs {
      display: flex;
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 0.5rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow);
      gap: 0.5rem;
    }

    .nav-tab {
      flex: 1;
      padding: 0.75rem 1.5rem;
      background: transparent;
      border: none;
      border-radius: var(--radius);
      font-size: 1rem;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .nav-tab:hover {
      background: rgba(0, 113, 227, 0.05);
      color: var(--primary);
    }

    .nav-tab.active {
      background: var(--primary);
      color: white;
    }

    .nav-tab svg {
      width: 20px;
      height: 20px;
    }

    /* Dashboard Styles */
    .dashboard-container {
      display: none;
    }

    .dashboard-container.active {
      display: block;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .kpi-card {
      background: var(--surface);
      padding: 1.5rem;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      transition: var(--transition);
    }

    .kpi-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    .kpi-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .kpi-title {
      font-size: 0.875rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .kpi-icon {
      width: 40px;
      height: 40px;
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.1;
    }

    .kpi-icon svg {
      width: 24px;
      height: 24px;
    }

    .kpi-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }

    .kpi-change {
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .kpi-change.positive {
      color: var(--success);
    }

    .kpi-change.negative {
      color: var(--danger);
    }

    .chart-container {
      background: var(--surface);
      padding: 2rem;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      margin-bottom: 1.5rem;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .chart-title {
      font-size: 1.25rem;
      font-weight: 600;
    }

    .chart-filters {
      display: flex;
      gap: 0.5rem;
    }

    .chart-filter {
      padding: 0.5rem 1rem;
      background: var(--background);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.875rem;
      cursor: pointer;
      transition: var(--transition);
    }

    .chart-filter:hover {
      border-color: var(--primary);
    }

    .chart-filter.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* Timeline Styles */
    .timeline-container {
      background: var(--surface);
      padding: 2rem;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      margin-top: 2rem;
    }

    .timeline {
      position: relative;
      padding: 1rem 0;
    }

    .timeline::before {
      content: '';
      position: absolute;
      left: 2rem;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--border);
    }

    .timeline-item {
      position: relative;
      padding-left: 5rem;
      padding-bottom: 2rem;
    }

    .timeline-item:last-child {
      padding-bottom: 0;
    }

    .timeline-marker {
      position: absolute;
      left: 1rem;
      top: 0;
      width: 2rem;
      height: 2rem;
      background: var(--surface);
      border: 2px solid var(--primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .timeline-marker.success {
      border-color: var(--success);
      background: var(--success);
    }

    .timeline-marker.warning {
      border-color: var(--warning);
      background: var(--warning);
    }

    .timeline-marker.danger {
      border-color: var(--danger);
      background: var(--danger);
    }

    .timeline-marker svg {
      width: 16px;
      height: 16px;
      color: white;
    }

    .timeline-content {
      background: var(--background);
      padding: 1rem;
      border-radius: var(--radius);
    }

    .timeline-date {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.25rem;
    }

    .timeline-title {
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .timeline-description {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    /* Estado Badge */
    .estado-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .estado-badge.simulado {
      background: rgba(0, 113, 227, 0.1);
      color: var(--primary);
    }

    .estado-badge.contratado {
      background: rgba(52, 199, 89, 0.1);
      color: var(--success);
    }

    .estado-badge.en_negociacion {
      background: rgba(255, 204, 0, 0.1);
      color: var(--warning);
    }

    .estado-badge.aprobado {
      background: rgba(52, 199, 89, 0.1);
      color: var(--success);
    }

    .estado-badge.en_pago {
      background: rgba(0, 113, 227, 0.1);
      color: var(--primary);
    }

    .estado-badge.completado {
      background: rgba(52, 199, 89, 0.1);
      color: var(--success);
    }

    .estado-badge.cancelado {
      background: rgba(255, 59, 48, 0.1);
      color: var(--danger);
    }

    /* Tabla de seguimiento */
    .seguimiento-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 2rem;
    }

    .seguimiento-table th {
      text-align: left;
      padding: 1rem;
      background: var(--background);
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .seguimiento-table td {
      padding: 1rem;
      border-top: 1px solid var(--border);
    }

    .seguimiento-table tr:hover {
      background: var(--background);
    }

    .cliente-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .cliente-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .cliente-nombre {
      font-weight: 500;
    }

    .cliente-ref {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    /* Loading Screen */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--background);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      transition: opacity 0.3s ease;
    }

    .loading-content {
      text-align: center;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Status Bar */
    .status-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .status-info {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-size: 0.875rem;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.25rem 0.75rem;
      background: var(--success);
      color: white;
      border-radius: 999px;
      font-weight: 500;
    }

    .status-badge.offline {
      background: var(--danger);
    }

    .main-wrapper {
      margin-top: 60px;
    }

    /* Componentes Base */
    .contenedor-simulador {
      max-width: 1200px;
      margin: 0 auto 40px;
      background: var(--surface);
      padding: 40px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      transition: var(--transition);
    }

    .header-simulador {
      text-align: center;
      margin-bottom: 3rem;
    }

    .logo {
      max-width: 120px;
      height: auto;
      border-radius: var(--radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 1.5rem;
    }

    h1, h2, h3 {
      margin: 0 0 1rem;
      font-weight: 600;
    }

    h1 { font-size: 2.5rem; }
    h2 { font-size: 1.5rem; }
    h3 { font-size: 1.25rem; }

    /* Formulario */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .campo {
      display: flex;
      flex-direction: column;
    }

    .campo label {
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .campo input,
    .campo select {
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 16px;
      transition: var(--transition);
      background: var(--surface);
    }

    .campo input:focus,
    .campo select:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.1);
    }

    .campo input.error {
      border-color: var(--danger);
    }

    .campo .help-text {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }

    /* Botones */
    .btn {
      cursor: pointer;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 500;
      border-radius: var(--radius);
      border: none;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
      white-space: nowrap;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .btn:active::before {
      width: 300px;
      height: 300px;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primario {
      background: var(--primary);
      color: white;
    }

    .btn-primario:hover:not(:disabled) {
      background: var(--primary-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 113, 227, 0.3);
    }

    .btn-secundario {
      background: transparent;
      color: var(--primary);
      border: 1px solid var(--primary);
    }

    .btn-secundario:hover:not(:disabled) {
      background: var(--primary);
      color: white;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover:not(:disabled) {
      background: #2ca548;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-icon {
      padding: 8px;
      width: 36px;
      height: 36px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    /* Tabla */
    .tabla-deudas {
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      margin-bottom: 2rem;
      background: var(--surface);
      overflow: hidden;
    }

    .tabla-deudas h2 {
      background: var(--primary);
      color: white;
      margin: 0;
      padding: 1rem 1.5rem;
      font-size: 1.25rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .tabla-scroll {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #f8f9fa;
    }

    th {
      text-align: left;
      font-weight: 600;
      padding: 1rem;
      border-bottom: 2px solid var(--border);
      color: var(--text-primary);
      white-space: nowrap;
    }

    td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }

    tbody tr {
      transition: background-color 0.2s;
    }

    tbody tr:hover {
      background: #f8f9fa;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .tabla-deudas input,
    .tabla-deudas select {
      width: 100%;
      min-width: 100px;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
    }

    .tabla-deudas input[type="number"] {
      text-align: right;
    }

    .importe-descuento {
      font-weight: 600;
      color: var(--success);
      text-align: right;
    }

    /* Resultados */
    .resultado-simulacion {
      margin-top: 2rem;
      padding: 2rem;
      background: linear-gradient(135deg, #fffbf0 0%, #fff4e0 100%);
      border-radius: var(--radius-lg);
      border: 1px solid #ffd93d;
      display: none;
      animation: slideUp 0.3s ease;
    }

    .resultado-simulacion h3 {
      color: var(--warning);
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .resultado-final {
      margin-top: 2rem;
      padding: 2rem;
      background: linear-gradient(135deg, #f2f8ff 0%, #e8f4fd 100%);
      border-radius: var(--radius-lg);
      border: 1px solid #dae7fe;
      display: none;
      animation: slideUp 0.3s ease;
    }

    .resultado-final h3 {
      color: var(--primary);
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .alerta-rentabilidad {
      background: var(--danger);
      color: white;
      padding: 1rem;
      border-radius: var(--radius);
      margin: 1.5rem 0;
      display: flex;
      gap: 1rem;
      align-items: start;
    }

    .alerta-rentabilidad p {
      margin: 0.5rem 0 0;
      font-size: 0.875rem;
      opacity: 0.9;
    }

    .resumen-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .resumen-item {
      background: white;
      padding: 1rem;
      border-radius: var(--radius);
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .resumen-item label {
      display: block;
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.25rem;
    }

    .resumen-item .valor {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--primary);
    }

    .resumen-item.warning .valor {
      color: var(--warning);
    }

    .resumen-item.danger .valor {
      color: var(--danger);
    }

    .comisiones-desglose {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: var(--radius);
      margin: 1rem 0;
    }

    .comisiones-desglose h4 {
      font-size: 1rem;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
    }

    .comisiones-desglose table {
      width: 100%;
      font-size: 0.875rem;
    }

    .comisiones-desglose td {
      padding: 0.25rem 0;
    }

    .comisiones-desglose .total {
      font-weight: 600;
      border-top: 1px solid var(--border);
      padding-top: 0.5rem;
      margin-top: 0.5rem;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.3s ease;
    }

    .modal-content {
      background: var(--surface);
      border-radius: var(--radius-lg);
      width: 90%;
      max-width: 800px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      animation: modalSlideUp 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes modalSlideUp {
      from {
        transform: translateY(50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-body {
      padding: 1.5rem;
      overflow-y: auto;
      flex: 1;
    }

    /* Lista de planes */
    .search-box {
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      width: 100%;
      margin-bottom: 1rem;
      font-size: 16px;
    }

    .planes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
    }

    .plan-card {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
      transition: var(--transition);
      cursor: pointer;
      background: white;
    }

    .plan-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
      border-color: var(--primary);
    }

    .plan-card-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 1rem;
    }

    .plan-card-title {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
    }

    .plan-card-ref {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .plan-card-date {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .plan-card-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }

    .plan-stat {
      text-align: center;
    }

    .plan-stat-value {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--primary);
    }

    .plan-stat-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    /* Notificaciones */
    .notificacion {
      position: fixed;
      top: 80px;
      right: 20px;
      padding: 16px 24px;
      border-radius: var(--radius);
      font-weight: 500;
      color: white;
      z-index: 9999;
      animation: slideIn 0.3s ease-out;
      box-shadow: var(--shadow-hover);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      max-width: 400px;
    }

    .notificacion.info { background: var(--primary); }
    .notificacion.success { background: var(--success); }
    .notificacion.error { background: var(--danger); }
    .notificacion.warning { background: var(--warning); color: var(--text-primary); }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .contenedor-simulador {
        padding: 1.5rem;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .planes-grid {
        grid-template-columns: 1fr;
      }

      .status-bar {
        flex-direction: column;
        gap: 1rem;
        padding: 1rem;
      }

      .main-wrapper {
        margin-top: 100px;
      }

      .notificacion {
        left: 20px;
        right: 20px;
        top: 120px;
        max-width: none;
      }

      .nav-tabs {
        flex-direction: column;
      }

      .nav-tab {
        width: 100%;
      }

      .kpi-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Utilidades */
    .text-center { text-align: center; }
    .text-right { text-align: right; }
    .mt-1 { margin-top: 0.5rem; }
    .mt-2 { margin-top: 1rem; }
    .mt-3 { margin-top: 1.5rem; }
    .mb-1 { margin-bottom: 0.5rem; }
    .mb-2 { margin-bottom: 1rem; }
    .mb-3 { margin-bottom: 1.5rem; }
    .d-none { display: none; }
    .d-flex { display: flex; }
    .justify-between { justify-content: space-between; }
    .justify-center { justify-content: center; }
    .align-center { align-items: center; }
    .gap-1 { gap: 0.5rem; }
    .gap-2 { gap: 1rem; }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <p>Cargando configuración...</p>
    </div>
  </div>

  <!-- Status Bar -->
  <div class="status-bar">
    <div class="status-info">
      <div class="status-badge" id="statusBadge">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        <span id="statusText">Conectado</span>
      </div>
      <span id="lastUpdate" style="color: var(--text-secondary); font-size: 0.75rem;"></span>
    </div>
    <div class="d-flex gap-1">
      <button class="btn btn-secundario" style="padding: 0.5rem 1rem; font-size: 0.875rem;" onclick="window.app && app.showInfo()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="16" x2="12" y2="12"></line>
          <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
        Info
      </button>
      <button class="btn btn-primario" style="padding: 0.5rem 1rem; font-size: 0.875rem;" onclick="window.app && app.syncData()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="23 4 23 10 17 10"></polyline>
          <polyline points="1 20 1 14 7 14"></polyline>
          <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
        </svg>
        Sincronizar
      </button>
    </div>
  </div>

  <div class="main-wrapper">
    <!-- Navigation Tabs -->
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="window.app && app.switchTab('dashboard', event)">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7"></rect>
          <rect x="14" y="3" width="7" height="7"></rect>
          <rect x="14" y="14" width="7" height="7"></rect>
          <rect x="3" y="14" width="7" height="7"></rect>
        </svg>
        Dashboard
      </button>
      <button class="nav-tab" onclick="window.app && app.switchTab('simulador', event)">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="20" x2="18" y2="10"></line>
          <line x1="12" y1="20" x2="12" y2="4"></line>
          <line x1="6" y1="20" x2="6" y2="14"></line>
        </svg>
        Simulador
      </button>
      <button class="nav-tab" onclick="window.app && app.switchTab('seguimiento', event)">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
        </svg>
        Seguimiento
      </button>
    </div>

    <!-- Dashboard Container -->
    <div id="dashboardContainer" class="dashboard-container active">
      <!-- KPIs -->
      <div class="kpi-grid">
        <div class="kpi-card">
          <div class="kpi-header">
            <div class="kpi-title">Planes Creados</div>
            <div class="kpi-icon" style="background: var(--primary);">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              </svg>
            </div>
          </div>
          <div class="kpi-value" id="kpiPlanesCreados">0</div>
          <div class="kpi-change positive">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="23 6 17 12 13 12 8 17 1 17"></polyline>
              <polyline points="17 6 23 6 23 12"></polyline>
            </svg>
            <span id="kpiPlanesCambio">+0% este mes</span>
          </div>
        </div>

        <div class="kpi-card">
          <div class="kpi-header">
            <div class="kpi-title">Tasa de Conversión</div>
            <div class="kpi-icon" style="background: var(--success);">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
              </svg>
            </div>
          </div>
          <div class="kpi-value" id="kpiConversion">0%</div>
          <div class="kpi-change positive">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="23 6 17 12 13 12 8 17 1 17"></polyline>
              <polyline points="17 6 23 6 23 12"></polyline>
            </svg>
            <span id="kpiConversionCambio">+0% vs mes anterior</span>
          </div>
        </div>

        <div class="kpi-card">
          <div class="kpi-header">
            <div class="kpi-title">Ahorro Total Generado</div>
            <div class="kpi-icon" style="background: var(--warning);">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <line x1="12" y1="1" x2="12" y2="23"></line>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
              </svg>
            </div>
          </div>
          <div class="kpi-value" id="kpiAhorro">0€</div>
          <div class="kpi-change positive">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="23 6 17 12 13 12 8 17 1 17"></polyline>
              <polyline points="17 6 23 6 23 12"></polyline>
            </svg>
            <span id="kpiAhorroCambio">+0% este mes</span>
          </div>
        </div>

        <div class="kpi-card">
          <div class="kpi-header">
            <div class="kpi-title">Comisiones Acumuladas</div>
            <div class="kpi-icon" style="background: var(--primary);">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
              </svg>
            </div>
          </div>
          <div class="kpi-value" id="kpiComisiones">0€</div>
          <div class="kpi-change positive">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="23 6 17 12 13 12 8 17 1 17"></polyline>
              <polyline points="17 6 23 6 23 12"></polyline>
            </svg>
            <span id="kpiComisionesCambio">+0% este mes</span>
          </div>
        </div>
      </div>

      <!-- Charts -->
      <div class="chart-container">
        <div class="chart-header">
          <h3 class="chart-title">Evolución Mensual de Planes</h3>
          <div class="chart-filters">
            <button class="chart-filter active" onclick="window.app && app.updateChart('evolucion', '6m', event)">6 Meses</button>
            <button class="chart-filter" onclick="window.app && app.updateChart('evolucion', '12m', event)">12 Meses</button>
            <button class="chart-filter" onclick="window.app && app.updateChart('evolucion', 'ytd', event)">Año Actual</button>
          </div>
        </div>
        <canvas id="chartEvolucion" width="400" height="200"></canvas>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
        <div class="chart-container">
          <div class="chart-header">
            <h3 class="chart-title">Distribución por Tipo de Deuda</h3>
          </div>
          <canvas id="chartDistribucion" width="200" height="200"></canvas>
        </div>

        <div class="chart-container">
          <div class="chart-header">
            <h3 class="chart-title">Funnel de Conversión</h3>
          </div>
          <canvas id="chartFunnel" width="200" height="200"></canvas>
        </div>
      </div>
    </div>

    <!-- Simulador Container -->
    <div id="simuladorContainer" class="contenedor-simulador" style="display: none;">
      <div class="header-simulador">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/44/Logo_DMD_Asesores.png/320px-Logo_DMD_Asesores.png" 
             alt="Logo DMD Asesores" 
             class="logo">
        <h1>Simulador de Reestructuración de Deuda</h1>
        <p style="color: var(--text-secondary); margin-top: -0.5rem;">
          Sistema colaborativo con sincronización en GitHub
        </p>
      </div>

      <form id="formularioSimulador">
        <div class="form-grid">
          <div class="campo">
            <label for="nombreDeudor">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              Nombre del Cliente
            </label>
            <input type="text" id="nombreDeudor" required placeholder="Ej: Juan Pérez García">
            <span class="help-text">Nombre completo del deudor</span>
          </div>

          <div class="campo">
            <label for="dniDeudor">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <path d="M14 2v6h6"></path>
                <line x1="12" y1="11" x2="12" y2="17"></line>
                <line x1="9" y1="14" x2="15" y2="14"></line>
              </svg>
              DNI/NIE
            </label>
            <input type="text" id="dniDeudor" required placeholder="Ej: 12345678A" pattern="[0-9]{8}[A-Za-z]|[XYZ][0-9]{7}[A-Za-z]">
            <span class="help-text">Documento de identidad</span>
          </div>

          <div class="campo">
            <label for="emailDeudor">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                <polyline points="22,6 12,13 2,6"></polyline>
              </svg>
              Email
            </label>
            <input type="email" id="emailDeudor" placeholder="correo@ejemplo.com">
            <span class="help-text">Para enviar el plan por correo</span>
          </div>

          <div class="campo">
            <label for="numCuotas">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
              Número de cuotas
            </label>
            <input type="number" id="numCuotas" min="1" max="360" value="12" required>
            <span class="help-text">Entre 1 y 360 meses</span>
          </div>
        </div>

        <div class="tabla-deudas">
          <h2>
            <span>Deudas a Incluir</span>
            <span id="totalDeudasCount" style="font-size: 0.9rem; font-weight: normal;">0 deudas</span>
          </h2>
          <div class="tabla-scroll">
            <table>
              <thead>
                <tr>
                  <th>Nº Contrato</th>
                  <th>Producto</th>
                  <th>Entidad</th>
                  <th>Importe (€)</th>
                  <th>% Desc.</th>
                  <th>Importe Final</th>
                  <th style="width: 50px;">Acción</th>
                </tr>
              </thead>
              <tbody id="tablaDeudas"></tbody>
              <tfoot>
                <tr style="background: #f8f9fa;">
                  <td colspan="3" style="text-align: right; font-weight: 600;">Totales:</td>
                  <td style="text-align: right; font-weight: 600;" id="totalImporte">0,00 €</td>
                  <td style="text-align: center; font-weight: 600;" id="totalDescuentoMedio">0%</td>
                  <td style="text-align: right; font-weight: 600; color: var(--success);" id="totalImporteFinal">0,00 €</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
          <div style="padding: 1rem;">
            <button type="button" class="btn btn-secundario" id="btnAgregarFila">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              Añadir Deuda
            </button>
            <button type="button" class="btn btn-secundario" id="btnCargarPlan">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
              Cargar Plan Guardado
            </button>
          </div>
        </div>

        <div class="d-flex justify-between align-center">
          <button type="button" class="btn btn-secundario" id="btnReAnalizar">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="23 4 23 10 17 10"></polyline>
              <polyline points="1 20 1 14 7 14"></polyline>
              <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
            Reiniciar
          </button>
          <div class="d-flex gap-1">
            <button type="button" class="btn btn-secundario" id="btnGuardarBorrador">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
              </svg>
              Guardar Borrador
            </button>
            <button type="button" class="btn btn-secundario" id="btnSimular">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 11H3v10h6V11zm4-8H7v18h6V3zm4 4h-6v14h6V7zm4 4h-6v10h6V11z"></path>
              </svg>
              Simular Plan
            </button>
            <button type="submit" class="btn btn-primario" id="btnCalcular" style="display: none;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Contratar y Guardar
            </button>
          </div>
        </div>
      </form>

      <!-- Vista previa de simulación -->
      <div class="resultado-simulacion" id="resultadoSimulacion" style="display: none;">
        <h3>
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle;">
            <path d="M9 11H3v10h6V11zm4-8H7v18h6V3zm4 4h-6v14h6V7zm4 4h-6v10h6V11z"></path>
          </svg>
          Simulación del Plan
        </h3>
        <div id="simulacion-content"></div>
        <div class="alerta-rentabilidad" id="alertaRentabilidad" style="display: none;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
            <line x1="12" y1="9" x2="12" y2="13"></line>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
          </svg>
          <div>
            <strong>Atención: Plan poco rentable</strong>
            <p id="mensajeRentabilidad"></p>
          </div>
        </div>
        <div class="d-flex gap-1 mt-2 justify-between">
          <button type="button" class="btn btn-secundario" onclick="window.app && app.modificarSimulacion()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
            Modificar
          </button>
          <div class="d-flex gap-1">
            <button type="button" class="btn btn-success" id="btnConfirmarPlan">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Confirmar y Contratar
            </button>
          </div>
        </div>
      </div>

      <div class="resultado-final" id="resultadoFinal">
        <h3>✓ Plan Guardado Correctamente</h3>
        <p>El plan ha sido guardado en el repositorio y está listo para ser enviado al cliente.</p>
        <div class="resumen-final" id="resumenFinal"></div>
        <div class="d-flex gap-1 mt-3 justify-center">
          <button class="btn btn-success" id="btnDescargarPDF">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Descargar PDF
          </button>
          <button class="btn btn-secundario" id="btnEnviarEmail">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
              <polyline points="22,6 12,13 2,6"></polyline>
            </svg>
            Enviar por Email
          </button>
          <button class="btn btn-secundario" id="btnVerEnGitHub">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
            </svg>
            Ver en GitHub
          </button>
          <button class="btn btn-primario" onclick="window.app && app.nuevoCliente()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Nuevo Cliente
          </button>
        </div>
      </div>
    </div>

    <!-- Seguimiento Container -->
    <div id="seguimientoContainer" class="contenedor-simulador" style="display: none;">
      <h2>Seguimiento de Planes</h2>
      
      <!-- Filtros -->
      <div class="form-grid mb-3">
        <div class="campo">
          <label>Buscar por cliente o referencia</label>
          <input type="text" id="buscarSeguimiento" placeholder="Nombre, DNI o referencia...">
        </div>
        <div class="campo">
          <label>Estado</label>
          <select id="filtroEstado">
            <option value="">Todos los estados</option>
            <option value="simulado">Simulado</option>
            <option value="contratado">Contratado</option>
            <option value="en_negociacion">En Negociación</option>
            <option value="aprobado">Aprobado</option>
            <option value="en_pago">En Pago</option>
            <option value="completado">Completado</option>
            <option value="cancelado">Cancelado</option>
          </select>
        </div>
        <div class="campo">
          <label>Período</label>
          <select id="filtroPeriodo">
            <option value="7">Últimos 7 días</option>
            <option value="30" selected>Últimos 30 días</option>
            <option value="90">Últimos 90 días</option>
            <option value="365">Último año</option>
            <option value="0">Todo</option>
          </select>
        </div>
      </div>

      <!-- Tabla de seguimiento -->
      <div class="tabla-deudas">
        <h2>
          <span>Planes en Seguimiento</span>
          <span id="totalPlanesSeguimiento" style="font-size: 0.9rem; font-weight: normal;">0 planes</span>
        </h2>
        <div class="tabla-scroll">
